# アプリケーションアーキテクチャ

## 全体アーキテクチャ

```
+----------------------------------+
|          クライアント             |
|  +----------------------------+  |
|  |     ブラウザ (PWA対応)      |  |
|  |  HTML / CSS / JavaScript   |  |
|  +----------------------------+  |
+-----|---------------------------|
      | HTTP/HTTPS
      v
+----------------------------------+
|           サーバー               |
|  +----------------------------+  |
|  |      Express.js API        |  |
|  +----------------------------+  |
|  |    ミドルウェア層           |  |
|  | (認証、バリデーション等)    |  |
|  +----------------------------+  |
|  |     ビジネスロジック層      |  |
|  | (スペース反復、ゲーミフィケーション) |
|  +----------------------------+  |
|  |      データアクセス層       |  |
|  +----------------------------+  |
+-----|---------------------------|
      | SQL
      v
+----------------------------------+
|        PostgreSQLデータベース    |
+----------------------------------+
```

## バックエンドアーキテクチャ（Node.js + Express + PostgreSQL）

### ディレクトリ構造

```
backend/
├── src/
│   ├── config/             # 設定ファイル
│   │   ├── db.js           # データベース接続設定
│   │   ├── jwt.js          # JWT設定
│   │   └── app.js          # アプリケーション設定
│   │
│   ├── controllers/        # コントローラー
│   │   ├── authController.js
│   │   ├── characterController.js
│   │   ├── progressController.js
│   │   └── gamificationController.js
│   │
│   ├── middleware/         # ミドルウェア
│   │   ├── auth.js         # 認証ミドルウェア
│   │   ├── validation.js   # バリデーションミドルウェア
│   │   ├── errorHandler.js # エラーハンドリング
│   │   └── rateLimiter.js  # レート制限
│   │
│   ├── models/             # データモデル
│   │   ├── User.js
│   │   ├── Character.js
│   │   ├── Progress.js
│   │   ├── Achievement.js
│   │   └── Session.js
│   │
│   ├── routes/             # ルート定義
│   │   ├── authRoutes.js
│   │   ├── characterRoutes.js
│   │   ├── progressRoutes.js
│   │   └── gamificationRoutes.js
│   │
│   ├── services/           # ビジネスロジック
│   │   ├── authService.js
│   │   ├── characterService.js
│   │   ├── progressService.js
│   │   ├── gamificationService.js
│   │   └── spacedRepetitionService.js
│   │
│   ├── utils/              # ユーティリティ関数
│   │   ├── logger.js
│   │   ├── helpers.js
│   │   └── validators.js
│   │
│   ├── db/                 # データベース関連
│   │   ├── migrations/     # マイグレーションファイル
│   │   └── seeds/          # シードデータ
│   │
│   └── app.js              # アプリケーションのエントリーポイント
│
├── tests/                  # テストファイル
├── package.json
└── .env                    # 環境変数
```

### レイヤー構造

1. **ルーティング層**
   - HTTPリクエストを受け取り、適切なコントローラーにルーティング
   - URLパラメータの基本的な検証

2. **ミドルウェア層**
   - 認証と認可
   - 入力バリデーション
   - レート制限
   - ロギング
   - エラーハンドリング

3. **コントローラー層**
   - リクエスト処理とレスポンス生成
   - サービス層の呼び出し
   - エラーのキャッチと適切なHTTPレスポンスへの変換

4. **サービス層**
   - ビジネスロジックの実装
   - トランザクション管理
   - 複数モデル間の連携処理
   - スペース反復アルゴリズムの実装
   - ゲーミフィケーションロジックの実装

5. **データアクセス層（モデル）**
   - データベースとのやり取り
   - クエリの実行
   - データの検証と整形

## フロントエンドアーキテクチャ（HTML/CSS/JavaScript）

### ディレクトリ構造

```
frontend/
├── public/
│   ├── index.html
│   ├── manifest.json       # PWAマニフェスト
│   ├── service-worker.js   # サービスワーカー
│   ├── favicon.ico
│   └── icons/              # アプリアイコン（各サイズ）
│
├── src/
│   ├── assets/
│   │   ├── images/         # 画像ファイル
│   │   ├── fonts/          # フォントファイル
│   │   └── sounds/         # 音声ファイル（効果音等）
│   │
│   ├── css/
│   │   ├── main.css        # メインスタイル
│   │   ├── components/     # コンポーネント別スタイル
│   │   └── pages/          # ページ別スタイル
│   │
│   ├── js/
│   │   ├── app.js          # アプリケーションのエントリーポイント
│   │   ├── api/            # APIクライアント
│   │   │   ├── api.js      # 基本APIクライアント
│   │   │   ├── auth.js     # 認証API
│   │   │   ├── characters.js # 文字API
│   │   │   ├── progress.js # 進捗API
│   │   │   └── gamification.js # ゲーミフィケーションAPI
│   │   │
│   │   ├── components/     # 再利用可能なコンポーネント
│   │   │   ├── Flashcard.js
│   │   │   ├── ProgressBar.js
│   │   │   ├── AchievementBadge.js
│   │   │   └── ...
│   │   │
│   │   ├── pages/          # ページコンポーネント
│   │   │   ├── Login.js
│   │   │   ├── Dashboard.js
│   │   │   ├── Study.js
│   │   │   ├── Quiz.js
│   │   │   └── Review.js
│   │   │
│   │   ├── utils/          # ユーティリティ関数
│   │   │   ├── auth.js     # 認証ヘルパー
│   │   │   ├── storage.js  # ローカルストレージ/IndexedDB
│   │   │   ├── animations.js # アニメーションヘルパー
│   │   │   └── validators.js # バリデーションヘルパー
│   │   │
│   │   └── services/       # ビジネスロジック
│   │       ├── authService.js
│   │       ├── studyService.js
│   │       └── offlineService.js
│   │
│   └── templates/          # HTMLテンプレート（必要に応じて）
│
└── package.json            # フロントエンド依存関係（ビルドツール用）
```

### アーキテクチャパターン

フロントエンドは**モジュラーMVC**パターンを採用:

1. **モデル (Model)**
   - APIクライアント
   - ローカルデータストア (IndexedDB)
   - データ操作ロジック

2. **ビュー (View)**
   - HTMLテンプレート
   - CSSスタイル
   - レンダリングロジック

3. **コントローラー (Controller)**
   - イベントハンドリング
   - ビューとモデルの連携
   - ルーティング

## データフロー

### 認証フロー

```
1. ユーザー → ログインフォーム入力
2. フロントエンド → バリデーション
3. フロントエンド → バックエンドAPI (/api/auth/login)
4. バックエンド → 認証情報検証
5. バックエンド → JWTトークン生成
6. バックエンド → フロントエンド (トークン返却)
7. フロントエンド → トークンをローカルストレージに保存
8. フロントエンド → ダッシュボードにリダイレクト
```

### 学習フロー

```
1. ユーザー → 学習開始
2. フロントエンド → バックエンドAPI (/api/progress/not-learned)
3. バックエンド → 未学習/復習予定の文字を取得
4. バックエンド → フロントエンド (文字データ返却)
5. フロントエンド → フラッシュカード表示
6. ユーザー → 「知っている」または「知らない」を選択
7. フロントエンド → バックエンドAPI (/api/progress/update)
8. バックエンド → スペース反復アルゴリズムで次回復習日を計算
9. バックエンド → 進捗データ更新
10. バックエンド → 経験値加算、レベルアップ確認
11. バックエンド → フロントエンド (更新結果返却)
12. フロントエンド → 次のカードを表示または結果サマリー表示
```

### オフラインサポートフロー

```
1. サービスワーカー → 静的アセットとAPIレスポンスをキャッシュ
2. ユーザー → オフライン状態で学習開始
3. フロントエンド → ネットワーク状態を検出
4. フロントエンド → キャッシュから文字データを取得
5. フロントエンド → ローカルストレージ/IndexedDBに進捗を一時保存
6. ユーザー → オンライン復帰
7. フロントエンド → 保存された進捗データをバックエンドと同期
```

## セキュリティアーキテクチャ

### 認証と認可

- JWTベースの認証システム
- アクセストークンとリフレッシュトークンの分離
- 保護されたAPIエンドポイントへのアクセス制御

### データ保護

- パスワードのbcryptハッシュ化
- センシティブデータの暗号化
- HTTPS通信の強制

### 入力検証

- サーバーサイドでの厳格な入力検証
- クライアントサイドでの事前バリデーション
- SQLインジェクション対策

## スケーラビリティ考慮事項

### 水平スケーリング

- ステートレスなバックエンドAPI設計
- セッションデータのデータベース保存
- 将来的な負荷分散対応

### キャッシュ戦略

- 頻繁に変更されないデータのキャッシュ
- クライアントサイドキャッシュの活用
- CDNの利用（将来拡張用）

## 監視とロギング

### ログ収集

- アプリケーションログ
- エラーログ
- アクセスログ

### パフォーマンスモニタリング

- APIレスポンスタイム
- データベースクエリパフォーマンス
- クライアント側のパフォーマンスメトリクス
